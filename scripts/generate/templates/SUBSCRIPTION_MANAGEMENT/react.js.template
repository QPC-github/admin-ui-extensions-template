import React, {useState, useEffect} from 'react';
import {ExtensionPoint, TextField, Text, Stack, Checkbox} from '@shopify/argo-admin';
import {render, useData, useContainer, useSessionToken} from '@shopify/argo-admin/react';

function Add() {
  const [selectedPlans, setSelectedPlans] = useState([]);
  const data = useData();
  const {close, done, setPrimaryAction, setSecondaryAction} = useContainer();
  const mockPlans = [
    {name: 'Subscription Plan A', id: 'a'},
    {name: 'Subscription Plan B', id: 'b'},
    {name: 'Subscription Plan C', id: 'c'},
  ];

  useEffect(() => {
    setPrimaryAction({
      content: 'Add to plan',
      onAction: async () => {
        const token = await getSessionToken();
        /**
        This is where you will need to submit the form data to your app server to add the new plan.
        You'll need to use the `token` value to authenticate this request on your app server.
        Upon completion, call done() to trigger a reload of the resource page and close() to close the modal.
        */
        done();
        close();
      },
    });

    setSecondaryAction({
      content: 'Cancel',
      onAction: () => close(),
    });
  }, []);

  return (
    <>
      <Text>
        Add {`{Product id ${data.productId}}`} to an existing plan or existing
        plans
      </Text>

      <Stack>
        {mockPlans.map((plan) => (
          <Checkbox
            key={plan.id}
            label={plan.name}
            onChange={(checked) => {
              const plans = checked
                ? selectedPlans.concat(plan.id)
                : selectedPlans.filter((id) => id !== plan.id);
              setSelectedPlans(plans);
            }}
            checked={selectedPlans.includes(plan.id)}
          />
        ))}
      </Stack>
    </>
  );
}

function Create() {
  const data = useData();
  const [planTitle, setPlanTitle] = useState('');
  const [percentageOff, setPercentageOff] = useState('');
  const [deliveryFrequency, setDeliveryFrequency] = useState('');
  const {close, done, setPrimaryAction, setSecondaryAction} = useContainer();

  useEffect(() => {
    setPrimaryAction({
      content: 'Create plan',
      onAction: async () => {
        const token = await getSessionToken();
        /**
        This is where you will need to submit the form data to your app server to create the new plan.
        You'll need to use the `token` value to authenticate this request on your app server.
        Upon completion, call done() to trigger a reload of the resource page and close() to close the modal.
        */
        done();
        close();
      },
    });

    setSecondaryAction({
      content: 'Cancel',
      onAction: () => close(),
    });
  }, []);

  return (
    <Stack vertical>
      <Text>
        Create subscription plan for {`{Product id ${data.productId}}`}
      </Text>

      <TextField
        label="Plan title"
        value={planTitle}
        onAfterChange={setPlanTitle}
      />

      <Stack>
        <TextField
          type="number"
          label="Delivery frequency (in weeks)"
          value={deliveryFrequency}
          onAfterChange={setDeliveryFrequency}
        />
        <TextField
          type="number"
          label="Percentage off (%)"
          value={percentageOff}
          onAfterChange={setPercentageOff}
        />
      </Stack>
    </Stack>
  );
}

function Remove() {
  const data = useData();
  const {close, done, setPrimaryAction, setSecondaryAction} = useContainer();

  useEffect(() => {
    setPrimaryAction({
      content: 'Remove from plan',
      onAction: async () => {
        const token = await getSessionToken();
        /**
        This is where you will need to submit the form data to your app server to remove the plan.
        You'll need to use the `token` value to authenticate this request on your app server.
        Upon completion, call done() to trigger a reload of the resource page and close() to close the modal.
        */
        done();
        close();
      },
    });

    setSecondaryAction({
      content: 'Cancel',
      onAction: () => close(),
    });
  }, []);

  return (
    <Text>
      Remove {`{Product id ${data.productId}}`} from{' '}
      {`{Plan group id ${data.sellingPlanGroupId}}`}
    </Text>
  );
}

function Edit() {
  const data = useData();
  const [planTitle, setPlanTitle] = useState('Current plan');
  const [percentageOff, setPercentageOff] = useState('10');
  const [deliveryFrequency, setDeliveryFrequency] = useState('1');
  const {close, done, setPrimaryAction, setSecondaryAction} = useContainer();

  useEffect(() => {
    setPrimaryAction({
      content: 'Edit plan',
      onAction: async () => {
        const token = await getSessionToken();
        /**
        This is where you will need to submit the form data to your app server to edit the plan.
        You'll need to use the `token` value to authenticate this request on your app server.
        Upon completion, call done() to trigger a reload of the resource page and close() to close the modal.
        */
        done();
        close();
      },
    });

    setSecondaryAction({
      content: 'Cancel',
      onAction: () => close(),
    });
  }, []);

  return (
    <Stack vertical>
      <Text>
        Create subscription plan for {`{Product id ${data.productId}}`}
      </Text>

      <TextField
        label="Plan title"
        value={planTitle}
        onAfterChange={setPlanTitle}
      />

      <Stack>
        <TextField
          type="number"
          label="Delivery frequency (in weeks)"
          value={deliveryFrequency}
          onAfterChange={setDeliveryFrequency}
        />
        <TextField
          type="number"
          label="Percentage off (%)"
          value={percentageOff}
          onAfterChange={setPercentageOff}
        />
      </Stack>
    </Stack>
  );
}

render(ExtensionPoint.SubscriptionManagementAdd, () => <Add />);
render(ExtensionPoint.SubscriptionManagementCreate, () => <Create />);
render(ExtensionPoint.SubscriptionManagementRemove, () => <Remove />);
render(ExtensionPoint.SubscriptionManagementEdit, () => <Edit />);
